<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام التقارير - كشر</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #8e44ad;
      --success: #27ae60;
      --danger: #e74c3c;
      --warning: #f39c12;
      --info: #3498db;
      --light: #ecf0f1;
      --dark: #2c3e40;
      --border-radius: 12px;
      --box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #333;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    h1 {
      color: var(--primary);
      margin-bottom: 10px;
      font-size: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
      background: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filter-group label {
      font-weight: 500;
    }

    select, input {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      font-family: 'Tajawal', sans-serif;
    }

    button {
      padding: 10px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Tajawal', sans-serif;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    button:hover {
      background: #1a252f;
    }

    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-card i {
      font-size: 2.5rem;
      margin-bottom: 15px;
    }

    .stat-card.primary i { color: var(--primary); }
    .stat-card.success i { color: var(--success); }
    .stat-card.warning i { color: var(--warning); }
    .stat-card.danger i { color: var(--danger); }
    .stat-card.info i { color: var(--info); }

    .stat-card h3 {
      font-size: 1.8rem;
      margin: 10px 0;
      color: var(--dark);
    }

    .stat-card p {
      color: #777;
      font-size: 0.9rem;
    }

    .charts-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    @media (max-width: 900px) {
      .charts-container {
        grid-template-columns: 1fr;
      }
    }

    .chart-box {
      background: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .chart-box h2 {
      margin-top: 0;
      margin-bottom: 20px;
      color: var(--primary);
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    canvas {
      width: 100% !important;
      max-height: 300px;
    }

    .tables-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    @media (max-width: 900px) {
      .tables-container {
        grid-template-columns: 1fr;
      }
    }

    .table-box {
      background: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow-x: auto;
    }

    .table-box h2 {
      margin-top: 0;
      margin-bottom: 20px;
      color: var(--primary);
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    th {
      background: var(--primary);
      color: white;
      font-weight: 500;
    }

    tr:hover {
      background: #f9f9f9;
    }

    .export-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 30px;
    }

    .loader {
      text-align: center;
      padding: 40px;
    }

    .loader .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-chart-line"></i> نظام التقارير والإحصائيات</h1>
      <p>تقارير شاملة عن مبيعات المتجر وأدائه</p>
    </header>

    <div class="controls">
      <div class="filter-group">
        <label>نوع التقرير:</label>
        <select id="reportType">
          <option value="daily">يومي</option>
          <option value="weekly">أسبوعي</option>
          <option value="monthly">شهري</option>
          <option value="yearly">سنوي</option>
        </select>
      </div>

      <div class="filter-group">
        <label>الفترة:</label>
        <input type="date" id="startDate">
        <span>إلى</span>
        <input type="date" id="endDate">
      </div>

      <button id="generateReport"><i class="fas fa-sync-alt"></i> توليد التقرير</button>
    </div>

    <div class="stats-cards">
      <div class="stat-card primary">
        <i class="fas fa-money-bill-wave"></i>
        <h3 id="totalSales">0</h3>
        <p>إجمالي المبيعات</p>
      </div>
      
      <div class="stat-card success">
        <i class="fas fa-cash-register"></i>
        <h3 id="cashSales">0</h3>
        <p>مبيعات نقدي</p>
      </div>
      
      <div class="stat-card warning">
        <i class="fas fa-credit-card"></i>
        <h3 id="installmentSales">0</h3>
        <p>مبيعات تقسيط</p>
      </div>
      
      <div class="stat-card info">
        <i class="fas fa-shopping-cart"></i>
        <h3 id="totalProducts">0</h3>
        <p>المنتجات المباعة</p>
      </div>
      
      <div class="stat-card danger">
        <i class="fas fa-file-invoice"></i>
        <h3 id="totalInvoices">0</h3>
        <p>عدد الفواتير</p>
      </div>
    </div>

    <div class="charts-container">
      <div class="chart-box">
        <h2><i class="fas fa-chart-bar"></i> المبيعات حسب النوع</h2>
        <canvas id="salesTypeChart"></canvas>
      </div>
      
      <div class="chart-box">
        <h2><i class="fas fa-chart-pie"></i> توزيع المبيعات</h2>
        <canvas id="salesDistributionChart"></canvas>
      </div>
    </div>

    <div class="tables-container">
      <div class="table-box">
        <h2><i class="fas fa-boxes"></i> المنتجات الأكثر مبيعاً</h2>
        <table>
          <thead>
            <tr>
              <th>المنتج</th>
              <th>الكمية</th>
              <th>الإيرادات</th>
            </tr>
          </thead>
          <tbody id="topProductsTable">
            <tr>
              <td colspan="3" style="text-align: center;">جار التحميل...</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="table-box">
        <h2><i class="fas fa-users"></i> العملاء الأكثر شراءً</h2>
        <table>
          <thead>
            <tr>
              <th>العميل</th>
              <th>عدد الفواتير</th>
              <th>إجمالي المشتريات</th>
            </tr>
          </thead>
          <tbody id="topCustomersTable">
            <tr>
              <td colspan="3" style="text-align: center;">جار التحميل...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="export-buttons">
      <button id="printReport"><i class="fas fa-print"></i> طباعة التقرير</button>
      <button id="exportPDF"><i class="fas fa-file-pdf"></i> تصدير PDF</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      query,
      where,
      orderBy,
      Timestamp
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDN5wPlEF_qANe8OSDESbveo_AMqYMCZLQ",
      authDomain: "kcher-dbb85.firebaseapp.com",
      projectId: "kcher-dbb85",
      storageBucket: "kcher-dbb85.firebasestorage.app",
      messagingSenderId: "83988845713",
      appId: "1:83988845713:web:4ef27c1da86ea07c8c1b30",
      measurementId: "G-VLGGZEM1YN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // عناصر DOM
    const reportTypeSelect = document.getElementById("reportType");
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const generateReportBtn = document.getElementById("generateReport");
    const totalSalesEl = document.getElementById("totalSales");
    const cashSalesEl = document.getElementById("cashSales");
    const installmentSalesEl = document.getElementById("installmentSales");
    const totalProductsEl = document.getElementById("totalProducts");
    const totalInvoicesEl = document.getElementById("totalInvoices");
    const topProductsTable = document.getElementById("topProductsTable");
    const topCustomersTable = document.getElementById("topCustomersTable");
    const printReportBtn = document.getElementById("printReport");
    const exportPDFBtn = document.getElementById("exportPDF");

    // المتغيرات العامة
    let salesTypeChart, salesDistributionChart;
    let reportData = {};

    // تعيين التواريخ الافتراضية
    function setDefaultDates() {
      const today = new Date();
      const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      
      startDateInput.valueAsDate = firstDayOfMonth;
      endDateInput.valueAsDate = today;
    }

    // تحميل التقارير
    async function loadReports() {
      const reportType = reportTypeSelect.value;
      const startDate = startDateInput.valueAsDate;
      const endDate = endDateInput.valueAsDate;
      
      if (!startDate || !endDate) {
        alert("يرجى تحديد تاريخ البداية والنهاية");
        return;
      }
      
      // إضافة يوم إلى endDate ليشمل اليوم بأكمله
      const endDatePlusOne = new Date(endDate);
      endDatePlusOne.setDate(endDatePlusOne.getDate() + 1);
      
      try {
        // استعلام الفواتير ضمن النطاق الزمني
        const invoicesQuery = query(
          collection(db, "invoices"),
          where("date", ">=", startDate.toISOString()),
          where("date", "<", endDatePlusOne.toISOString())
        );
        
        const invoicesSnapshot = await getDocs(invoicesQuery);
        
        // تهيئة بيانات التقرير
        reportData = {
          totalSales: 0,
          cashSales: 0,
          installmentSales: 0,
          totalProducts: 0,
          totalInvoices: 0,
          products: {},
          customers: {},
          dailySales: {}
        };
        
        // معالجة البيانات
        invoicesSnapshot.forEach(doc => {
          const data = doc.data();
          const invoiceDate = new Date(data.date);
          const dayKey = invoiceDate.toLocaleDateString("ar-EG");
          
          reportData.totalSales += data.total || 0;
          reportData.totalInvoices += 1;
          
          if (data.type === "cash") {
            reportData.cashSales += data.total || 0;
          } else if (data.type === "installment") {
            reportData.installmentSales += data.total || 0;
          }
          
          // تجميع بيانات المنتجات
          if (data.products) {
            data.products.forEach(product => {
              reportData.totalProducts += product.quantity || 0;
              
              if (!reportData.products[product.name]) {
                reportData.products[product.name] = {
                  quantity: 0,
                  revenue: 0
                };
              }
              
              reportData.products[product.name].quantity += product.quantity || 0;
              reportData.products[product.name].revenue += (product.quantity || 0) * (product.salePrice || 0);
            });
          }
          
          // تجميع بيانات العملاء (للبيع بالتقسيط)
          if (data.type === "installment" && data.customer) {
            const customerKey = `${data.customer.name}-${data.customer.phone}`;
            
            if (!reportData.customers[customerKey]) {
              reportData.customers[customerKey] = {
                name: data.customer.name,
                phone: data.customer.phone,
                invoices: 0,
                total: 0
              };
            }
            
            reportData.customers[customerKey].invoices += 1;
            reportData.customers[customerKey].total += data.total || 0;
          }
          
          // تجميع المبيعات اليومية
          if (!reportData.dailySales[dayKey]) {
            reportData.dailySales[dayKey] = 0;
          }
          reportData.dailySales[dayKey] += data.total || 0;
        });
        
        // تحديث واجهة المستخدم
        updateUI();
        
      } catch (error) {
        console.error("Error loading reports: ", error);
        alert("حدث خطأ أثناء تحميل البيانات");
      }
    }

    // تحديث واجهة المستخدم
    function updateUI() {
      // تحديث الإحصائيات
      totalSalesEl.textContent = reportData.totalSales.toLocaleString();
      cashSalesEl.textContent = reportData.cashSales.toLocaleString();
      installmentSalesEl.textContent = reportData.installmentSales.toLocaleString();
      totalProductsEl.textContent = reportData.totalProducts.toLocaleString();
      totalInvoicesEl.textContent = reportData.totalInvoices.toLocaleString();
      
      // تحديث جدول المنتجات الأكثر مبيعاً
      updateTopProductsTable();
      
      // تحديث جدول العملاء الأكثر شراءً
      updateTopCustomersTable();
      
      // تحديث الرسوم البيانية
      updateCharts();
    }

    // تحديث جدول المنتجات الأكثر مبيعاً
    function updateTopProductsTable() {
      const productsArray = Object.entries(reportData.products)
        .map(([name, data]) => ({ name, ...data }))
        .sort((a, b) => b.revenue - a.revenue)
        .slice(0, 5);
      
      topProductsTable.innerHTML = '';
      
      if (productsArray.length === 0) {
        topProductsTable.innerHTML = '<tr><td colspan="3" style="text-align: center;">لا توجد بيانات</td></tr>';
        return;
      }
      
      productsArray.forEach(product => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${product.name}</td>
          <td>${product.quantity}</td>
          <td>${product.revenue.toLocaleString()} جنيه</td>
        `;
        topProductsTable.appendChild(row);
      });
    }

    // تحديث جدول العملاء الأكثر شراءً
    function updateTopCustomersTable() {
      const customersArray = Object.values(reportData.customers)
        .sort((a, b) => b.total - a.total)
        .slice(0, 5);
      
      topCustomersTable.innerHTML = '';
      
      if (customersArray.length === 0) {
        topCustomersTable.innerHTML = '<tr><td colspan="3" style="text-align: center;">لا توجد بيانات</td></tr>';
        return;
      }
      
      customersArray.forEach(customer => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${customer.name}<br><small>${customer.phone}</small></td>
          <td>${customer.invoices}</td>
          <td>${customer.total.toLocaleString()} جنيه</td>
        `;
        topCustomersTable.appendChild(row);
      });
    }

    // تحديث الرسوم البيانية
    function updateCharts() {
      // رسم بياني لأنواع المبيعات
      const salesTypeCtx = document.getElementById('salesTypeChart').getContext('2d');
      if (salesTypeChart) salesTypeChart.destroy();
      
      salesTypeChart = new Chart(salesTypeCtx, {
        type: 'doughnut',
        data: {
          labels: ['نقدي', 'تقسيط'],
          datasets: [{
            data: [reportData.cashSales, reportData.installmentSales],
            backgroundColor: [ '#27ae60', '#f39c12' ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
      
      // رسم بياني للتوزيع اليومي للمبيعات
      const salesDistributionCtx = document.getElementById('salesDistributionChart').getContext('2d');
      if (salesDistributionChart) salesDistributionChart.destroy();
      
      const dailySalesLabels = Object.keys(reportData.dailySales);
      const dailySalesData = Object.values(reportData.dailySales);
      
      salesDistributionChart = new Chart(salesDistributionCtx, {
        type: 'line',
        data: {
          labels: dailySalesLabels,
          datasets: [{
            label: 'المبيعات اليومية',
            data: dailySalesData,
            backgroundColor: 'rgba(52, 152, 219, 0.2)',
            borderColor: '#3498db',
            borderWidth: 2,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // طباعة التقرير
    printReportBtn.addEventListener('click', () => {
      window.print();
    });

    // تصدير PDF (وهمي للعرض)
    exportPDFBtn.addEventListener('click', () => {
      alert("سيتم تصدير التقرير كملف PDF. هذه الميزة قيد التطوير.");
    });

    // أحداث
    generateReportBtn.addEventListener('click', loadReports);
    
    // تهيئة الصفحة
    setDefaultDates();
    loadReports();
  </script>
</body>
</html>